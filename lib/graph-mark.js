!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.GraphMark=e():t.GraphMark=e()}(this,(function(){return function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([function(t,e){t.exports=function(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}},function(t,e,i){"use strict";i.r(e),i.d(e,"Mark",(function(){return o}));var s=i(0),r=i.n(s);function a(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function n(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?a(i,!0).forEach((function(e){r()(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):a(i).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class o{constructor(t){r()(this,"defaultOptions",{canvasTagId:null,maxResultsLength:1e6}),r()(this,"options",null),r()(this,"state",{scale:1,x:0,y:0,minZoom:.02,maxZoom:15}),r()(this,"zoomFactor",0),r()(this,"image",null),r()(this,"currentDrawing",null),r()(this,"mouseCoordinate",{lastPoint:null}),r()(this,"cursorState",{rect:!1}),r()(this,"results",[]),"string"==typeof t&&(t={canvasTagId:t});var e=n({},this.defaultOptions,{},t);if(!e.canvasTagId)throw new Error("canvasTagId should be a string.");this.options=e,this.canvas=new fabric.Canvas(e.canvasTagId),this.canvas.selection=!1}get imageWidth(){return this.image&&this.image.get("width")}get imageHeight(){return this.image&&this.image.get("height")}init(t){this.clear(),this.image=new fabric.Image(t),this.image.set({hasRotatingPoint:!1,hasControls:!1,selectable:!1,lockMovementX:!0,lockMovementY:!0}),this.initVptScale(),this.canvas.add(this.image),this.canvas.on("mouse:down",this.mousedownEventListener.bind(this)),this.canvas.on("mouse:move",this.mousemoveEventListener.bind(this)),this.canvas.on("mouse:up",this.mouseupEventListener.bind(this)),this.canvas.on("mouse:wheel",this.mousewheelEventListener.bind(this))}mousedownEventListener(t){if(this.image){var e=this.getMouseCoordinate(t);e.vptX>=0&&e.vptY>=0&&e.vptX<=this.imageWidth&&e.vptY<=this.imageHeight&&(this.cursorState.rect&&!this.currentDrawing?(this.currentDrawing=new fabric.Rect({left:e.vptX,top:e.vptY,width:0,height:0,scaleX:1,scaleY:1,stroke:"#ff425f",strokeWidth:3,fill:"transparent",selectable:!1,hasRotatingPoint:!1,hasControls:!1}),this.currentDrawing.startPointCoordinate={vptX:e.vptX,vptY:e.vptY},this.canvas.add(this.currentDrawing)):this.cursorState.rect||(this.mouseCoordinate.lastPoint=e))}}mousemoveEventListener(t){if(this.image){var e=this.getMouseCoordinate(t);if(this.cursorState.rect&&this.currentDrawing){var i=this.currentDrawing.startPointCoordinate.vptX,s=this.currentDrawing.startPointCoordinate.vptY,r=Math.min(i,e.vptX),a=Math.min(s,e.vptY),n=Math.abs(e.vptX-i),o=Math.abs(e.vptY-s);r<0&&(n+=r,r=0),a<0&&(o+=a,a=0),r+n>this.imageWidth&&(n=this.imageWidth-r),a+o>this.imageHeight&&(o=this.imageHeight-a),this.currentDrawing.set({left:r,top:a,width:n,height:o}),this.canvas.renderAll()}else!this.cursorState.rect&&this.mouseCoordinate.lastPoint&&this.move(e,this.mouseCoordinate.lastPoint)}}mouseupEventListener(t){if(this.image){if(this.cursorState.rect&&this.currentDrawing){var e=this.currentDrawing.get("width"),i=this.currentDrawing.get("height");e<10||i<10?this.canvas.remove(this.currentDrawing):this.updateContainer(this.currentDrawing),this.currentDrawing=null}this.mouseCoordinate.lastPoint=null}}mousewheelEventListener(t){if(this.image){var e=0;t.e.wheelDelta?e=-t.e.wheelDelta/120*1e3:t.e.detail&&(e=t.e.detail/3*1e3),this.zoomFactor+=e,this.vptScale(t)}}initVptScale(){var t=this.imageWidth,e=this.imageHeight,i=this.canvas.get("width"),s=this.canvas.get("height"),r=0,a=0,n=1;if(t>i||e>s){var o=i/t,h=s/e;n=o<h?o:h,o<h?a=(s-e*n)/2:r=(i-t*n)/2}else r=(i-t)/2,a=(s-e)/2;this.setState({scale:n,x:r,y:a}),this.render()}vptScale(t){if(!isNaN(this.zoomFactor)){t.e.preventDefault&&(t=this.getMouseCoordinate(t));var e=this.zoomFactor/-5e3;e=Math.min(.5,Math.max(-.5,e));var i=this.state.scale+this.state.scale*e;if(this.zoomFactor=0,i<this.state.minZoom?i=this.state.minZoom:i>this.state.maxZoom&&(i=this.state.maxZoom),i!==this.state.scale){var s=i/this.state.scale,r=this.state.x,a=this.state.y,n=t.zoomX,o=t.zoomY,h=s*(r-n)+n,c=s*(a-o)+o;this.setState({scale:i,x:h,y:c}),this.render()}}}render(){var t=[this.state.scale,0,0,this.state.scale,this.state.x,this.state.y];this.canvas.setViewportTransform(t)}setState(t){this.state=n({},this.state,{},t)}move(t,e){var i=t.zoomX-e.zoomX,s=t.zoomY-e.zoomY,r=this.state.x+i,a=this.state.y+s;this.setState({x:r,y:a}),this.render(),this.mouseCoordinate.lastPoint=t}getMouseCoordinate(t){var e=t.pointer.x,i=t.pointer.y,s=this.state.scale;return{zoomX:e,zoomY:i,vptX:(e-this.state.x)/s,vptY:(i-this.state.y)/s}}updateContainer(t){this.results.length>=this.options.maxResultsLength&&(this.results.shift(0,1),this.canvas.remove(this.canvas.item(1))),this.results.push({x:t.get("left"),y:t.get("top"),width:t.get("width"),height:t.get("height")})}clearRect(){for(var t=this.canvas.size(),e=0;e<t;e++){var i=this.canvas.item(e);i.startPointCoordinate&&this.canvas.remove(i)}this.results=[]}clear(){this.canvas.clear(),this.image=null,this.state={scale:1,x:0,y:0,minZoom:.02,maxZoom:15},this.zoomFactor=0,this.cursorState={rect:!1},this.results=[],this.render()}}}])}));